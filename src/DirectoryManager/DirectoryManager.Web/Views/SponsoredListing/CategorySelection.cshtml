@using DirectoryManager.Data.Enums
@using DirectoryManager.Data.Models
@using DirectoryManager.Web.Constants
@model IEnumerable<DirectoryEntry>

@{
    ViewData[StringConstants.TitleHeader] = "Select Sponsored Listing by Category";
    ViewData[StringConstants.IsIndexable] = false;

    // values set by controller (CategorySelection)
    var categoryId = ViewBag.CategoryId is int c ? c : 0;
    Guid? reservationGuid = ViewBag.ReservationGuid is Guid g ? g : (Guid?)null;
    DateTime? reservationExpiresUtc = ViewBag.ReservationExpiresUtc is DateTime d ? d : (DateTime?)null;

    int? minutesLeft = reservationExpiresUtc.HasValue
        ? (int?)Math.Max(0, (int)Math.Ceiling((reservationExpiresUtc.Value - DateTime.UtcNow).TotalMinutes))
        : null;
}

@{
    Layout = "_CenteredLayout";
}

@section PageContent {
<h1>@ViewData[StringConstants.TitleHeader]</h1>
<hr />

@if (reservationGuid.HasValue && reservationExpiresUtc.HasValue)
{
    <div class="alert alert-warning" role="alert">
        <strong>Reserved checkout:</strong>
        Your ad slot is reserved until
        <b>@reservationExpiresUtc.Value.ToString(DirectoryManager.Common.Constants.StringConstants.DateTimeFormat)</b> UTC
        (@minutesLeft minute@(minutesLeft == 1 ? "" : "s") left).
        Use the <em>Select</em> links below to continue before it expires.
    </div>
}

@foreach (var entry in Model)
{
    <div>
        <a target="_blank" href="@entry.Link">@entry.Name</a> –
        <a rel="nofollow"
           href="@Url.Action(
                    "SelectDuration",
                    "SponsoredListing",
                    new {
                        directoryEntryId = entry.DirectoryEntryId,
                        sponsorshipType  = SponsorshipType.CategorySponsor,
                        categoryId       = categoryId,
                        rsvId            = reservationGuid
                    })">
            Select
        </a>
    </div>
}
}
