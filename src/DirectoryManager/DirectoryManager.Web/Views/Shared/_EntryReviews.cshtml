@using DirectoryManager.Web.Services.Interfaces
@using Microsoft.AspNetCore.Html
@using System.Text.RegularExpressions
@using System.Net
@using System.Text.Json
@using DirectoryManager.Data.Models
@using System.Globalization
@model DirectoryManager.Web.Models.EntryReviewsBlockViewModel
@inject IUrlResolutionService Urls

@functions {
    // CSS class so long links wrap onto multiple lines
    private const string LinkClass = "multi-line-text";

    // Precompiled URL regex: http(s)://... or www....
    private static readonly Regex UrlRegex = new(
        @"(?:(?:https?://)|(?:www\.))[\w\-\.]+(?:\.[a-z]{2,})(?:[^\s<>]*)?",
        RegexOptions.IgnoreCase | RegexOptions.CultureInvariant | RegexOptions.Compiled);

    // Render body: encode text, auto-link URLs, preserve newlines
    public static IHtmlContent RenderBodyWithLinks(string? text)
    {
        if (string.IsNullOrEmpty(text))
            return new HtmlString(string.Empty);

        var sb = new System.Text.StringBuilder();
        int last = 0;

        foreach (Match m in UrlRegex.Matches(text))
        {
            string before = WebUtility.HtmlEncode(text.Substring(last, m.Index - last))
                                      .Replace("\r\n", "\n").Replace("\n", "<br/>");
            sb.Append(before);

            string raw = m.Value;
            string trimmed = raw.TrimEnd('.', ',', ';', ')', ']', '}', '!', '?', '>', '"', '\'');
            string trailing = raw.Substring(trimmed.Length);

            string href = trimmed.StartsWith("www.", StringComparison.OrdinalIgnoreCase)
                ? $"https://{trimmed}"
                : trimmed;

            string hrefAttr = WebUtility.HtmlEncode(href);
            string visible = WebUtility.HtmlEncode(trimmed);

            sb.Append($"<a class=\"{LinkClass}\" href=\"{hrefAttr}\" target=\"_blank\" rel=\"noopener noreferrer nofollow ugc\">{visible}</a>");

            if (trailing.Length > 0)
                sb.Append(WebUtility.HtmlEncode(trailing));

            last = m.Index + m.Length;
        }

        string tail = WebUtility.HtmlEncode(text.Substring(last))
                                .Replace("\r\n", "\n").Replace("\n", "<br/>");
        sb.Append(tail);

        return new HtmlString(sb.ToString());
    }

    // helper to resolve replies safely
    public static List<DirectoryEntryReviewComment> GetReplies(
        Dictionary<int, List<DirectoryEntryReviewComment>>? dict, int reviewId)
    {
        if (dict == null) return new List<DirectoryEntryReviewComment>();
        return dict.TryGetValue(reviewId, out var list) && list != null
            ? list
            : new List<DirectoryEntryReviewComment>();
    }

    // ✅ Same star-fill markup used elsewhere (rating-wrapper/stars/stars-fill/rating-text)
    // Use this only for aggregates where count matters.
    public static IHtmlContent RenderAggregateStars(double? avg, int? count)
    {
        if (!avg.HasValue || !count.HasValue || count.Value <= 0)
        {
            return new HtmlString(string.Empty);
        }

        const int totalStars = 5;
        double percent = Math.Clamp(avg.Value / totalStars * 100.0, 0.0, 100.0);

        var sb = new System.Text.StringBuilder();

        sb.Append("<span class=\"rating-wrapper\" aria-label=\"");
        sb.Append(WebUtility.HtmlEncode($"{avg.Value:0.0} out of 5 stars from {count.Value} reviews"));
        sb.Append("\">");

        sb.Append("<span class=\"stars\">");
        sb.Append("<span class=\"stars-fill\" style=\"width:");
        sb.Append(percent.ToString("0.##", CultureInfo.InvariantCulture));
        sb.Append("%\"></span>");
        sb.Append("</span>");

        sb.Append("<span class=\"rating-text\"> ");
        sb.Append(avg.Value.ToString("0.0", CultureInfo.InvariantCulture));
        sb.Append("/5 (");
        sb.Append(count.Value.ToString(CultureInfo.InvariantCulture));
        sb.Append(")</span>");

        sb.Append("</span>");

        return new HtmlString(sb.ToString());
    }

    // ✅ Per-review stars: same CSS, but NO "(count)" because it’s a single review.
    public static IHtmlContent RenderSingleReviewStars(byte? rating)
    {
        if (!rating.HasValue || rating.Value < 1)
        {
            return new HtmlString(string.Empty);
        }

        double val = Math.Clamp((double)rating.Value, 0.0, 5.0);
        const int totalStars = 5;
        double percent = Math.Clamp(val / totalStars * 100.0, 0.0, 100.0);

        var sb = new System.Text.StringBuilder();

        sb.Append("<span class=\"rating-wrapper\" aria-label=\"");
        sb.Append(WebUtility.HtmlEncode($"{val:0}/5"));
        sb.Append("\">");

        sb.Append("<span class=\"stars\">");
        sb.Append("<span class=\"stars-fill\" style=\"width:");
        sb.Append(percent.ToString("0.##", CultureInfo.InvariantCulture));
        sb.Append("%\"></span>");
        sb.Append("</span>");

        // no (1) here
        sb.Append("</span>");

        return new HtmlString(sb.ToString());
    }
}

@{
    // Current page URL for JSON-LD itemReviewed @id
    var pageUrl = this.ViewData[DirectoryManager.Web.Constants.StringConstants.CanonicalUrl];
}

<div class="reviews-block mt-4">
    <h3 class="mb-3">Reviews</h3>

    @if (Model.ReviewCount > 0)
    {
        <p>
            <strong>Average rating:</strong>
            @Html.Raw(RenderAggregateStars(Model.AverageRating, Model.ReviewCount).ToString())
        </p>

        <ul class="list-unstyled">
            @foreach (var r in Model.Reviews)
            {
                var replies = GetReplies(Model.RepliesByReviewId, r.DirectoryEntryReviewId);

                <li class="mb-4 pb-3 border-bottom" itemscope itemtype="https://schema.org/Review">

                    <div class="d-flex align-items-center">
                        @if (r.Rating.HasValue)
                        {
                            @Html.Raw(RenderSingleReviewStars(r.Rating).ToString())
                            <small class="text-muted ms-2">@r.Rating.Value/5</small>
                        }
                        else
                        {
                            <small class="text-muted">No rating</small>
                        }

                        <!-- reviewRating microdata -->
                        <span itemprop="reviewRating" itemscope itemtype="https://schema.org/Rating">
                            <meta itemprop="ratingValue" content="@((r.Rating ?? 0))" />
                            <meta itemprop="bestRating" content="5" />
                            <meta itemprop="worstRating" content="1" />
                        </span>
                    </div>

                    <div class="mt-2" itemprop="reviewBody">
                        @RenderBodyWithLinks(r.Body)
                    </div>

                    <div class="mt-2">
                        <!-- author microdata -->
                        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
                            <small class="text-muted multi-line-text">
                                Author: @(string.IsNullOrWhiteSpace(r.DisplayName) ? r.AuthorFingerprint : r.DisplayName)
                            </small>
                        </span>

                        <small class="text-muted ms-2">•</small>

                        <!-- datePublished microdata -->
                        <time class="text-muted ms-2"
                              itemprop="datePublished"
                              datetime="@r.CreateDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateFormat)">
                            @r.CreateDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateFormat)
                        </time>
                    </div>

                    <!-- Reply CTA -->
                    <div class="mt-3">
                        <form action="@Urls.ResolveToApp("/directory-entry-review-replies/begin")"
                              method="post"
                              class="d-inline"
                              rel="nofollow">
                            <input type="hidden" name="directoryEntryReviewId" value="@r.DirectoryEntryReviewId" />
                            <input type="text" name="website" value="" style="display:none" tabindex="-1" autocomplete="off" />
                            <button class="btn review-btn btn-sm btn-outline-secondary" type="submit">Reply</button>
                        </form>
                    </div>

                    <!-- Threaded replies -->
                    @if (replies.Any())
                    {
                        <div class="mt-3 ps-3 border-start">
                            <div class="text-muted mb-2"><small><strong>Replies</strong></small></div>

                            <ul class="list-unstyled mb-0">
                                @foreach (var c in replies)
                                {
                                    <li class="mb-3">
                                        <div class="mt-1">
                                            @RenderBodyWithLinks(c.Body)
                                        </div>

                                        <div class="mt-2">
                                            <small class="text-muted multi-line-text">
                                                Author: @(string.IsNullOrWhiteSpace(c.DisplayName) ? c.AuthorFingerprint : c.DisplayName)
                                            </small>
                                            <small class="text-muted ms-2">•</small>
                                            <time class="text-muted ms-2"
                                                  datetime="@((c.UpdateDate ?? c.CreateDate).ToString(DirectoryManager.Common.Constants.StringConstants.DateFormat))">
                                                @((c.UpdateDate ?? c.CreateDate).ToString(DirectoryManager.Common.Constants.StringConstants.DateFormat))
                                            </time>
                                        </div>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                </li>
            }
        </ul>

        @* JSON-LD *@
        {
            var graph = new List<object>();

            if (Model.AverageRating.HasValue && Model.ReviewCount > 0)
            {
                graph.Add(new
                {
                    @type = "AggregateRating",
                    itemReviewed = new { @id = pageUrl },
                    ratingValue = Math.Round(Model.AverageRating.Value, 1),
                    ratingCount = Model.ReviewCount,
                    bestRating = 5,
                    worstRating = 1
                });
            }

            foreach (var r in Model.Reviews)
            {
                var authorText = r.AuthorFingerprint;

                graph.Add(new
                {
                    @type = "Review",
                    itemReviewed = new { @id = pageUrl },
                    reviewRating = new
                    {
                        @type = "Rating",
                        ratingValue = (int)(r.Rating ?? 0),
                        bestRating = 5,
                        worstRating = 1
                    },
                    author = new { @type = "Person", name = authorText },
                    datePublished = r.CreateDate.ToString(DirectoryManager.Common.Constants.StringConstants.DateFormat),
                    reviewBody = r.Body ?? string.Empty
                });
            }

            var jsonLd = JsonSerializer.Serialize(new
            {
                @context = "https://schema.org",
                @graph = graph
            }, new JsonSerializerOptions { Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping });

            <script type="application/ld+json">
                @Html.Raw(jsonLd)
            </script>
        }
    }
    else
    {
        <p class="text-muted">No reviews yet.</p>
    }

    <form action="@Urls.ResolveToApp("/directory-entry-reviews/begin")" method="post" class="d-inline" rel="nofollow">
        <input type="hidden" name="directoryEntryId" value="@Model.DirectoryEntryId" />
        <button class="btn review-btn" type="submit">Leave a review</button>
    </form>
</div>
