@using DirectoryManager.DisplayFormatting.Helpers
@using DirectoryManager.Web.Constants
@using DirectoryManager.Web.Models
@using DirectoryManager.Web.Services.Interfaces
@inject DirectoryManager.Web.Services.Interfaces.ICacheService cacheService
@inject IUrlResolutionService urlService
@model SearchViewModel

@{
    if (!Model.Entries.Any())
    {
        ViewData[StringConstants.TitleHeader] = "No results found.";
    }
    else
    {
        ViewData[StringConstants.TitleHeader] = $"Search results for \"{Model.Query}\"";
    }

    Layout = "_CenteredLayout";

    var q = Model.Query ?? string.Empty;
    var encodedQ = System.Net.WebUtility.UrlEncode(q);
}

@section PageContent {
    <div class="page-header-bar">
        <h1 class="page-title">@ViewData[StringConstants.TitleHeader]</h1>
        @await Html.PartialAsync("_SiteLogo")
    </div>

    <hr />
    @await Html.PartialAsync("_BackToHome")
    <hr />

    <div style="text-align:center">
        <form method="get" class="search-form mb-3" action="">
            <input type="search"
                   maxlength="50"
                   name="q"
                   class="form-control"
                   placeholder="Search…"
                   autocomplete="off"
                   aria-label="Search directory" />

            <input type="hidden" name="page" value="1" />

            <button type="submit" class="btn btn-primary search-btn">Search</button>
        </form>
    </div>

    @if (!Model.Entries.Any())
    {
        <p>No results found.</p>
    }
    else
    {
        <p><i>Showing @Model.Entries.Count of @Model.TotalCount results.</i></p>

        <ul class="search-results">
            @foreach (var e in Model.Entries)
            {
                @Html.Raw(DisplayMarkUpHelper.GenerateSearchResultHtml(e, urlService.BaseUrl))
            }
        </ul>

        <nav aria-label="Search pagination">
            <ul class="pagination">
                @{
                    int totalPages = (int)Math.Ceiling(Model.TotalCount / (double)Model.PageSize);
                    for (int p = 1; p <= totalPages; p++)
                    {
                        <li class="page-item @(p == Model.Page ? "active" : "")">
                            <a class="page-link" href="?q=@encodedQ&page=@p">@p</a>
                        </li>
                    }
                }
            </ul>
        </nav>
    }

    <hr />

    @await Html.PartialAsync("_SponsoredListingPartial")
}
