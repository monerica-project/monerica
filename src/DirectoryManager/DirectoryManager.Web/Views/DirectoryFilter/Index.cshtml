@using DirectoryManager.Data.Enums
@using DirectoryManager.Web.Constants
@using Microsoft.AspNetCore.WebUtilities
@using DirectoryManager.DisplayFormatting.Helpers
@using DirectoryManager.Web.Models
@using DirectoryManager.Web.Services.Interfaces
@inject IUrlResolutionService urlService
@inject DirectoryManager.Data.Repositories.Interfaces.IDirectoryEntryReviewRepository reviewRepo
@model DirectoryFilterViewModel

@{
    Layout = "_CenteredLayout";
    ViewData[StringConstants.TitleHeader] = "Directory Filter";
    ViewData[StringConstants.MetaContent] = StringConstants.MetaTagNoIndex;
}

@section PageContent {
    <div class="page-header-bar">
        <h1 class="page-title">@ViewData[StringConstants.TitleHeader]</h1>
        @await Html.PartialAsync("_SiteLogo")
    </div>

    <hr />
    @await Html.PartialAsync("_BackToHome")
    <hr />

    <form method="get" class="mb-3 filter-form ui-form">

        <!-- Status -->
        <fieldset class="ui-fieldset">
            <legend class="ui-legend">Status</legend>

            @{
                var selected = new HashSet<DirectoryStatus>(Model.Query.Statuses ?? new List<DirectoryStatus>());

                var orderedStatuses = new[]
                {
                    DirectoryStatus.Verified,
                    DirectoryStatus.Admitted,
                    DirectoryStatus.Questionable,
                    DirectoryStatus.Scam
                };
            }

            <div class="ui-checks">
                @foreach (var st in orderedStatuses)
                {
                    <label class="ui-check">
                        <input type="checkbox"
                               name="Statuses"
                               value="@st"
                               @(selected.Contains(st) ? "checked=\"checked\"" : null) />
                        <span>@st</span>
                    </label>
                }
            </div>
        </fieldset>

        <!-- Location / Links -->
        <fieldset class="ui-fieldset">
            <legend class="ui-legend">Location / Links</legend>

            <label class="ui-label-block">
                <span class="ui-label-text">Country</span>

                <span class="ui-select-wrap">
                    <select name="Country" class="ui-select">
                        @if (string.IsNullOrWhiteSpace(Model.Query.Country))
                        {
                            <option value="" selected="selected">All</option>
                        }
                        else
                        {
                            <option value="">All</option>
                        }
                        @foreach (var c in Model.CountryOptions)
                        {
                            if (string.Equals(Model.Query.Country, c.Code, StringComparison.OrdinalIgnoreCase))

                            {
                                <option value="@c.Code" selected="selected">@c.Name (@c.Code)</option>
                            }
                            else
                            {
                                <option value="@c.Code">@c.Name (@c.Code)</option>
                            }
                        }
                    </select>
                </span>
            </label>

            <div class="ui-checks">
                <label class="ui-check">
                    <input type="checkbox" name="HasVideo" value="true" @(Model.Query.HasVideo ? "checked=\"checked\"" : null) />
                    <span>Has Video</span>
                </label>

                <label class="ui-check">
                    <input type="checkbox" name="HasTor" value="true" @(Model.Query.HasTor ? "checked=\"checked\"" : null) />
                    <span>Has Tor (.onion)</span>
                </label>

                <label class="ui-check">
                    <input type="checkbox" name="HasI2p" value="true" @(Model.Query.HasI2p ? "checked=\"checked\"" : null) />
                    <span>Has I2P (.i2p)</span>
                </label>
            </div>
        </fieldset>

        <!-- Categorization -->
        <fieldset class="ui-fieldset">
            <legend class="ui-legend">Categorization</legend>

            <label class="ui-label-block">
                <span class="ui-label-text">Category</span>

                <span class="ui-select-wrap">
                    <select name="CategoryId" class="ui-select">
                        @if (!Model.Query.CategoryId.HasValue || Model.Query.CategoryId.Value <= 0)
                        {
                            <option value="" selected="selected">All</option>
                        }
                        else
                        {
                            <option value="">All</option>
                        }


                        @foreach (var cat in Model.CategoryOptions)
                        {
                            if (Model.Query.CategoryId == cat.Id)
                            {
                                <option value="@cat.Id" selected="selected">@cat.Name</option>
                            }
                            else
                            {
                                <option value="@cat.Id">@cat.Name</option>
                            }
                        }
                    </select>
                </span>
            </label>

            @if (Model.Query.CategoryId.HasValue && Model.Query.CategoryId.Value > 0)
            {
                <label class="ui-label-block">
                    <span class="ui-label-text">Subcategory</span>

                    <span class="ui-select-wrap">
                        <select name="SubCategoryId" class="ui-select">
                            @if (!Model.Query.SubCategoryId.HasValue || Model.Query.SubCategoryId.Value <= 0)
                            {
                                <option value="" selected="selected">All</option>
                            }
                            else
                            {
                                <option value="">All</option>
                            }
                            @foreach (var sc in Model.SubCategoryOptions)
                            {
                                if (Model.Query.SubCategoryId == sc.Id)
                                {
                                    <option value="@sc.Id" selected="selected">@sc.Name</option>
                                }
                                else
                                {
                                    <option value="@sc.Id">@sc.Name</option>
                                }
                            }
                        </select>
                    </span>
                </label>
            }

            @if (Model.Query.CategoryId.HasValue && Model.Query.CategoryId.Value > 0)
            {
                var selectedTagIds = new HashSet<int>(Model.Query.TagIds ?? new List<int>());

                <div class="ui-tags">
                    <div class="ui-tags-title">Tags (in this category)</div>

                    @if (Model.CategoryTagOptions == null || Model.CategoryTagOptions.Count == 0)
                    {
                        <div class="ui-empty"><i>No tags found for this category.</i></div>
                    }
                    else
                    {
                        <div class="ui-tags-box">
                            @foreach (var t in Model.CategoryTagOptions)
                            {
                                <label class="ui-check">
                                    <input type="checkbox"
                                           name="TagIds"
                                           value="@t.Id"
                                           @(selectedTagIds.Contains(t.Id) ? "checked=\"checked\"" : null) />
                                    <span>@t.Name</span>
                                </label>
                            }
                        </div>
                    }
                </div>
            }
        </fieldset>

        <!-- Sort -->
        <fieldset class="ui-fieldset">
            <legend class="ui-legend">Sort</legend>

            <label class="ui-label-block">
                <span class="ui-label-text">Sort by</span>

                <span class="ui-select-wrap">
                    <select name="Sort" class="ui-select">
                        @{
                            var sort = Model.Query.Sort;
                        }
                        @if (sort == DirectoryFilterSort.Newest)
                        {
                            <option value="Newest" selected="selected">Newest</option>
                        }
                        else
                        {
                            <option value="Newest">Newest</option>
                        }
                        @if (sort == DirectoryFilterSort.Oldest)
                        {
                            <option value="Oldest" selected="selected">Oldest</option>
                        }
                        else
                        {
                            <option value="Oldest">Oldest</option>
                        }
                        @if (sort == DirectoryFilterSort.HighestRating)
                        {
                            <option value="HighestRating" selected="selected">Highest rating</option>
                        }
                        else
                        {
                            <option value="HighestRating">Highest rating</option>
                        }
                        @if (sort == DirectoryFilterSort.LowestRating)
                        {
                            <option value="LowestRating" selected="selected">Lowest rating</option>
                        }
                        else
                        {
                            <option value="LowestRating">Lowest rating</option>
                        }
                        @if (sort == DirectoryFilterSort.NameAsc)
                        {
                            <option value="NameAsc" selected="selected">Name (A–Z)</option>
                        }
                        else
                        {
                            <option value="NameAsc">Name (A–Z)</option>
                        }
                        @if (sort == DirectoryFilterSort.NameDesc)
                        {
                            <option value="NameDesc" selected="selected">Name (Z–A)</option>
                        }
                        else
                        {
                            <option value="NameDesc">Name (Z–A)</option>
                        }
                    </select>
                </span>
            </label>
        </fieldset>

        <input type="hidden" name="Page" value="1" />
        <input type="hidden" name="PageSize" value="@Model.Query.PageSize" />

        <div class="ui-actions" style="padding-bottom:5px;">
            <button type="submit" class="btn btn-primary ui-submit btn-cta">
                Apply Filters
            </button>

            <a class="no-app-link ui-clear"
               href="@(Url.Action("Index", "DirectoryFilter") ?? "/filter")?Page=1&PageSize=@Model.Query.PageSize">
                Clear
            </a>
        </div>
    </form>

    @* Sponsor block (only when filtering by category OR subcategory) *@
    @{
        string BuildItemPath(DirectoryManager.DisplayFormatting.Models.DirectoryEntryViewModel vm)
        {
            return "/site/" + vm.DirectoryEntryKey;
        }

        void EnsureSponsorReviewLinking(DirectoryManager.DisplayFormatting.Models.DirectoryEntryViewModel? vm)
        {
            if (vm == null) return;

            vm.LinkType = DirectoryManager.DisplayFormatting.Enums.LinkType.ListingPage;

            if (string.IsNullOrWhiteSpace(vm.ItemPath))
            {
                vm.ItemPath = BuildItemPath(vm);
            }
        }

        var sponsorIds = new List<int>();

        var subVm = Model?.SubcategorySponsorModel?.DirectoryEntry;
        var catVm = Model?.CategorySponsorModel?.DirectoryEntry;

        if (subVm != null && subVm.DirectoryEntryId > 0) sponsorIds.Add(subVm.DirectoryEntryId);
        if (catVm != null && catVm.DirectoryEntryId > 0) sponsorIds.Add(catVm.DirectoryEntryId);

        Dictionary<int, DirectoryManager.Data.Models.TransferModels.RatingSummaryDto> sponsorRatings = new();

        if (sponsorIds.Count > 0)
        {
            sponsorRatings = await reviewRepo.GetRatingSummariesAsync(sponsorIds);
        }

        if (subVm != null)
        {
            if (sponsorRatings.TryGetValue(subVm.DirectoryEntryId, out var sum))
            {
                subVm.AverageRating = sum.ReviewCount > 0 ? sum.AvgRating : null;
                subVm.ReviewCount = sum.ReviewCount > 0 ? sum.ReviewCount : null;
            }

            EnsureSponsorReviewLinking(subVm);
        }

        if (catVm != null)
        {
            if (sponsorRatings.TryGetValue(catVm.DirectoryEntryId, out var sum))
            {
                catVm.AverageRating = sum.ReviewCount > 0 ? sum.AvgRating : null;
                catVm.ReviewCount = sum.ReviewCount > 0 ? sum.ReviewCount : null;
            }

            EnsureSponsorReviewLinking(catVm);
        }
    }

    @if (Model?.SubcategorySponsorModel != null)
    {
        @await Html.PartialAsync("_SponsoredListingSubCategoryPartial", Model.SubcategorySponsorModel)
    }
    else if (Model?.CategorySponsorModel != null)
    {
        @await Html.PartialAsync("_SponsoredListingCategoryPartial", Model.CategorySponsorModel)
    }

    <hr />

    @if (!Model.Entries.Any())
    {
        <p>No results found.</p>
    }
    else
    {
        <p><i>Showing @Model.Entries.Count of @Model.TotalCount results.</i></p>

        <ul class="search-results">
            @foreach (var e in Model.Entries)
            {
                @Html.Raw(DisplayMarkUpHelper.GenerateSearchResultHtml(e, urlService.BaseUrl))
            }
        </ul>

        int totalPages = (int)Math.Ceiling(Model.TotalCount / (double)Model.Query.PageSize);
        int currentPage = Model.Query.Page < 1 ? 1 : Model.Query.Page;

        var current = new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase);
        foreach (var kv in Context.Request.Query)
        {
            if (string.Equals(kv.Key, "Page", StringComparison.OrdinalIgnoreCase)) continue;
            if (string.Equals(kv.Key, "Statuses", StringComparison.OrdinalIgnoreCase)) continue;
            if (string.Equals(kv.Key, "TagIds", StringComparison.OrdinalIgnoreCase)) continue;

            current[kv.Key] = kv.Value.ToString();
        }

        string BuildUrlForPage(int page)
        {
            var url = Url.Action("Index", "DirectoryFilter") ?? "/filter";

            var qs = new Dictionary<string, string?>(current)
            {
                ["Page"] = page.ToString(),
                ["PageSize"] = Model.Query.PageSize.ToString()
            };

            var tmp = QueryHelpers.AddQueryString(url, qs);

            if (Model.Query.Statuses is { Count: > 0 })
            {
                foreach (var st in Model.Query.Statuses)
                {
                    tmp = QueryHelpers.AddQueryString(tmp, "Statuses", st.ToString());
                }
            }

            if (Model.Query.TagIds is { Count: > 0 })
            {
                foreach (var tid in Model.Query.TagIds)
                {
                    tmp = QueryHelpers.AddQueryString(tmp, "TagIds", tid.ToString());
                }
            }

            return tmp;
        }

        bool hasPrev = currentPage > 1;
        bool hasNext = currentPage < totalPages;

        string prevUrl = hasPrev ? BuildUrlForPage(currentPage - 1) : "#";
        string nextUrl = hasNext ? BuildUrlForPage(currentPage + 1) : "#";

        <nav aria-label="Directory pagination">
            <ul class="pagination">
                <li class="page-item @(hasPrev ? "" : "disabled")">
                    <a class="page-link" href="@(hasPrev ? prevUrl : "#")" aria-label="Previous" tabindex="@(hasPrev ? "0" : "-1")">
                        &laquo; Previous
                    </a>
                </li>

                <li class="page-item disabled">
                    <span class="page-link">Page @currentPage of @totalPages</span>
                </li>

                <li class="page-item @(hasNext ? "" : "disabled")">
                    <a class="page-link" href="@(hasNext ? nextUrl : "#")" aria-label="Next" tabindex="@(hasNext ? "0" : "-1")">
                        Next &raquo;
                    </a>
                </li>
            </ul>
        </nav>
    }

    <hr />
    @await Html.PartialAsync("_SponsoredListingPartial")
}
