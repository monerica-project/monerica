@using DirectoryManager.Data.Enums
@using DirectoryManager.Data.Models
@using DirectoryManager.Data.Repositories.Interfaces
@using DirectoryManager.Web.Constants
@using DirectoryManager.Web.Helpers
@using DirectoryManager.Web.Models
@model DirectoryManager.Web.Models.CategoryEntriesViewModel
@inject DirectoryManager.Web.Services.Interfaces.ICacheService cacheHelper
@inject DirectoryManager.Data.Repositories.Interfaces.ISponsoredListingRepository sponsoredListingRepository
@inject ICategoryRepository categoryRepo
@inject ISubcategoryRepository subCatRepo
@inject DirectoryManager.Web.Services.Interfaces.IUrlResolutionService UrlResolver
@inject DirectoryManager.Data.Repositories.Interfaces.IDirectoryEntryReviewRepository directoryEntryReviewRepository

@{
    ViewData["CurrentCategoryKey"] = Model.CategoryKey;
    ViewData["CurrentSubCategoryKey"] = null;
}

@{
  Layout = "_LayoutWithNav";
  ViewData[StringConstants.TitleHeader] = "Category: " + Model.CategoryName + (Model.CurrentPage > 1 ? $" (Page {Model.CurrentPage})" : "");
  ViewData[StringConstants.MetaDescription] = Model.MetaDescription;
}
 
@{
    var domain = await cacheHelper.GetSnippetAsync(SiteConfigSetting.CanonicalDomain);

    // Build your breadcrumb list dynamically based on page context
    var breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem { Position = 1, Name = "Home", Url = UrlHelper.MakeFullUrl(domain,"/") },
        new BreadcrumbItem { Position = 2, Name = Model.CategoryName, Url = UrlHelper.MakeFullUrl(domain,$"/{@Model.CategoryKey}") }
    };
}

@BreadcrumbJsonHelper.GenerateBreadcrumbJson(breadcrumbs)
 
 @section PageContent {

    <div class="top-section search-section search-top-align">
        @await Html.PartialAsync("_SearchForm", new DirectoryManager.Web.Models.SearchFormViewModel
        {
            FilterCategoryId = Model.CategoryId
        })
</div>

<h1>@Model.CategoryName</h1>

<hr />

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a class="no-app-link" href="@UrlResolver.ResolveToRoot("~/")">Home</a>
        </li>
        <li class="breadcrumb-item" aria-current="page">
            @Model.CategoryName
        </li>
    </ol>
</nav>

@if (!string.IsNullOrWhiteSpace(Model.Description))
{
    <p><span>@Html.Raw(Model.Description)</span></p>
}

@if (!string.IsNullOrWhiteSpace(Model.Note))
{
    <p><i>Note: @Html.Raw(Model.Note)</i></p>
}

    @{
        var link2Name = await cacheHelper.GetSnippetAsync(SiteConfigSetting.Link2Name);
        var link3Name = await cacheHelper.GetSnippetAsync(SiteConfigSetting.Link3Name);

        var categorySponsors = await sponsoredListingRepository.GetActiveSponsorsByTypeAsync(SponsorshipType.CategorySponsor);

        // find the sponsor for this category (if any)
        var catSponsor = categorySponsors
            .FirstOrDefault(s => s.DirectoryEntry?.SubCategory?.CategoryId == Model.CategoryId);

        var catSponsorCount = categorySponsors.Count();

        // ✅ Pull rating summary (AvgRating + ReviewCount) for the sponsor entry
        DirectoryManager.Data.Models.TransferModels.RatingSummaryDto? sponsorRating = null;

        if (catSponsor?.DirectoryEntry != null)
        {
            var sponsorId = catSponsor.DirectoryEntry.DirectoryEntryId;

            var ratingDict = await directoryEntryReviewRepository.GetRatingSummariesAsync(new[] { sponsorId });

            if (ratingDict.TryGetValue(sponsorId, out var dto))
            {
                sponsorRating = dto;
            }
        }

        var categorySponsorModel = new DirectoryManager.Web.Models.CategorySponsorModel()
        {
            CategoryId = Model.CategoryId,
            TotalActiveCategoryListings = catSponsorCount,

            DirectoryEntry = (catSponsor != null && catSponsor.DirectoryEntry != null)
                ? new DirectoryManager.DisplayFormatting.Models.DirectoryEntryViewModel()
                {
                    CountryCode = catSponsor.DirectoryEntry.CountryCode,

                    CreateDate = catSponsor.DirectoryEntry.CreateDate,
                    UpdateDate = catSponsor.DirectoryEntry.UpdateDate,
                    DateOption = DirectoryManager.DisplayFormatting.Enums.DateDisplayOption.NotDisplayed,

                    Link = catSponsor.DirectoryEntry.Link,
                    LinkA = catSponsor.DirectoryEntry.LinkA,
                    Link2 = catSponsor.DirectoryEntry.Link2,
                    Link2A = catSponsor.DirectoryEntry.Link2A,
                    Link3 = catSponsor.DirectoryEntry.Link3,
                    Link3A = catSponsor.DirectoryEntry.Link3A,

                    Name = catSponsor.DirectoryEntry.Name,
                    Contact = catSponsor.DirectoryEntry.Contact,
                    Description = catSponsor.DirectoryEntry.Description,
                    DirectoryEntryId = catSponsor.DirectoryEntry.DirectoryEntryId,
                    DirectoryStatus = catSponsor.DirectoryEntry.DirectoryStatus,
                    Location = catSponsor.DirectoryEntry.Location,
                    Note = catSponsor.DirectoryEntry.Note,
                    Processor = catSponsor.DirectoryEntry.Processor,

                    SubCategoryId = catSponsor.DirectoryEntry.SubCategoryId,
                    SubCategory = catSponsor.DirectoryEntry.SubCategory,

                    DirectoryEntryKey = catSponsor.DirectoryEntry.DirectoryEntryKey,

                    // ✅ needed for (count) link to #reviews if your helper uses ItemPath
                    ItemPath = DirectoryManager.DisplayFormatting.Helpers.FormattingHelper.ListingPath(catSponsor.DirectoryEntry.DirectoryEntryKey),

                    IsSponsored = true,
                    DisplayAsSponsoredItem = false,

                    Link2Name = link2Name,
                    Link3Name = link3Name,

                    // IMPORTANT: you want listing page links here (your existing choice)
                    LinkType = DirectoryManager.DisplayFormatting.Enums.LinkType.ListingPage,

                    // ✅ Ratings mapped from RatingSummaryDto
                    AverageRating = (sponsorRating != null && sponsorRating.ReviewCount > 0)
                        ? sponsorRating.AvgRating
                        : null,

                    ReviewCount = (sponsorRating != null && sponsorRating.ReviewCount > 0)
                        ? sponsorRating.ReviewCount
                        : null
                }
                : null
        };
    }
    @await Html.PartialAsync("_SponsoredListingCategoryPartial", categorySponsorModel)
 
    @{
        var grouped = Model.PagedEntries.Items
            .GroupBy(e => e.SubCategory?.Name ?? "Uncategorized")
            .OrderBy(g => g.Key, StringComparer.OrdinalIgnoreCase);
    }

    @foreach (var group in grouped)
    {
        <h2 class="subcat-heading">@group.Key</h2>
        <ul class="blank_list_item">
            @foreach (var entryVm in group)
            {
                entryVm.LinkType = DirectoryManager.DisplayFormatting.Enums.LinkType.ListingPage;

                if (Model.SponsoredDirectoryEntryIds.Contains(entryVm.DirectoryEntryId))
                {
                    entryVm.IsSponsored = true;
                    entryVm.DisplayAsSponsoredItem = true;
                    entryVm.LinkType = DirectoryManager.DisplayFormatting.Enums.LinkType.ListingPage;
                }

                @await Html.PartialAsync("_DirectoryEntryPartial", entryVm)
            }
        </ul>
    }

    @{
        var categoryKey = Model.CategoryKey;
        int totalPages = (int)Math.Ceiling(Model.PagedEntries.TotalCount / (double)Model.PageSize);
        int currentPage = Model.CurrentPage < 1 ? 1 : Model.CurrentPage;
    }

    @if (totalPages > 1)
    {
        <nav aria-label="Pagination">
            <ul class="pagination">
                @for (int p = 1; p <= totalPages; p++)
                {
                    // Build the raw path: page 1 is "/{categoryKey}", subsequent pages add "/page/{p}"
                    string rawPath = $"/{categoryKey}" + (p > 1 ? $"/page/{p}" : "");

                    // Page 1 → canonical root; pages 2+ → app domain
                    string href = p == 1
                        ? UrlResolver.BaseUrl.TrimEnd('/') + rawPath
                        : UrlResolver.ResolveToApp(rawPath);

                    var isActive = (p == currentPage);

                    <li class="page-item @(isActive ? "active" : "")">
                        @if (isActive)
                        {
                            <span class="page-link" aria-current="page">@p</span>
                        }
                        else
                        {
                            <a class="page-link no-app-link" href="@href">@p</a>
                        }
                    </li>
                }
            </ul>
        </nav>
    }

<hr />

@await Html.PartialAsync("_SponsoredListingPartial")

}