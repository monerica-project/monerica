@using DirectoryManager.Web.Constants
@using DirectoryManager.Data.Enums
@using DirectoryManager.Data.Models
@using DirectoryManager.Web.Models
@using DirectoryManager.Web.Models.Reviews
@model ReviewModerationQueueViewModel

@{
    Layout = "_CenteredLayout";
    ViewData[StringConstants.TitleHeader] = "Pending Moderation Queue";
}

@section PageContent {

    <h1>@ViewData[StringConstants.TitleHeader]</h1>

    @await Html.PartialAsync("_AdminMenu")

    <p class="mb-3">
        <a asp-action="All" asp-route-status="Approved">Approved Reviews</a> |
        <a asp-action="All" asp-route-status="Rejected">Rejected Reviews</a> |
        <a asp-action="All">All Reviews</a>
    </p>

    <!-- ===================== -->
    <!-- Pending Reviews -->
    <!-- ===================== -->

    <h2 class="mt-3">Pending Reviews</h2>

    @if (!Model.PendingReviews.Any())
    {
        <p><i>No pending reviews.</i></p>
    }
    else
    {
        <div class="table-wrapper">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Entry</th>
                        <th>Rating</th>
                        <th>Title</th>
                        <th>Order Proof</th>
                        <th>Created (UTC)</th>
                        <th>Fingerprint</th>
                        <th>Excerpt</th>
                        <th style="width:220px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Model.PendingReviews)
                    {
                        var proof = r.OrderUrl ?? r.OrderId;

                        <tr>
                            <td>@r.DirectoryEntryReviewId</td>
                            <td>
                                <a href="~/directoryentry/edit/@r.DirectoryEntryId">
                                    @r.DirectoryEntryId
                                </a>
                            </td>
                            <td>@(r.Rating?.ToString() ?? "-")</td>
                            <td>@(string.IsNullOrWhiteSpace(r.Title) ? "-" : r.Title)</td>

                            <td>
                                @if (string.IsNullOrWhiteSpace(proof))
                                {
                                    <span class="text-muted">—</span>
                                }
                                else if (!string.IsNullOrWhiteSpace(r.OrderUrl))
                                {
                                    <a href="@r.OrderUrl" target="_blank" rel="noopener">@r.OrderUrl</a>
                                }
                                else
                                {
                                    @r.OrderId
                                }
                            </td>

                            <td>@r.CreateDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td><code>@r.AuthorFingerprint</code></td>
                            <td>
                                @(string.IsNullOrWhiteSpace(r.Body)
                                                    ? "-"
                                                    : (r.Body.Length > 80 ? r.Body[..80] + "…" : r.Body))
                            </td>
                            <td>
                                <a asp-action="Show"
                                   asp-route-id="@r.DirectoryEntryReviewId">
                                    View
                                </a>

                                <form asp-action="Approve"
                                      asp-route-id="@r.DirectoryEntryReviewId"
                                      method="post"
                                      class="d-inline ms-1">
                                    @Html.AntiForgeryToken()
                                    <button type="submit">Approve</button>
                                </form>

                                <a asp-action="Show"
                                   asp-route-id="@r.DirectoryEntryReviewId"
                                   class="ms-1">
                                    Reject/Delete…
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <!-- ===================== -->
    <!-- Pending Replies -->
    <!-- ===================== -->

    <hr />
    <h2 class="mt-4">Pending Replies</h2>

    @if (!Model.PendingReplies.Any())
    {
        <p><i>No pending replies.</i></p>
    }
    else
    {
        <div class="table-wrapper">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Review</th>
                        <th>Created (UTC)</th>
                        <th>Fingerprint</th>
                        <th>Excerpt</th>
                        <th style="width:220px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in Model.PendingReplies)
                    {
                        <tr>
                            <td>@c.DirectoryEntryReviewCommentId</td>
                            <td>
                                <a asp-action="Show"
                                   asp-route-id="@c.DirectoryEntryReviewId">
                                    @c.DirectoryEntryReviewId
                                </a>
                            </td>
                            <td>@c.CreateDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td><code>@c.AuthorFingerprint</code></td>
                            <td>
                                @(string.IsNullOrWhiteSpace(c.Body)
                                                    ? "-"
                                                    : (c.Body.Length > 80 ? c.Body[..80] + "…" : c.Body))
                            </td>
                            <td>
                                <a asp-action="ShowReply"
                                   asp-route-id="@c.DirectoryEntryReviewCommentId">
                                    View
                                </a>

                                <form asp-action="ApproveReply"
                                      asp-route-id="@c.DirectoryEntryReviewCommentId"
                                      method="post"
                                      class="d-inline ms-1">
                                    @Html.AntiForgeryToken()
                                    <button type="submit">Approve</button>
                                </form>

                                <a asp-action="ShowReply"
                                   asp-route-id="@c.DirectoryEntryReviewCommentId"
                                   class="ms-1">
                                    Reject/Delete…
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <!-- ===================== -->
    <!-- Pagination -->
    <!-- ===================== -->
    @if (ViewBag.Page is int pageNumber &&
             ViewBag.PageSize is int pageSize &&
             ViewBag.ReviewTotal is int reviewTotal)
    {
        var last = Math.Max(1, (int)Math.Ceiling(reviewTotal / (double)pageSize));

        <div class="mt-3">
            <span>Page @pageNumber of @last (@reviewTotal total reviews)</span>
            <div>
                @if (pageNumber > 1)
                {
                    <a asp-action="Pending"
                       asp-route-page="@(pageNumber - 1)"
                       asp-route-pageSize="@pageSize">
                        Prev
                    </a>
                    @: |
                }
                @if (pageNumber < last)
                {
                    <a asp-action="Pending"
                       asp-route-page="@(pageNumber + 1)"
                       asp-route-pageSize="@pageSize">
                        Next
                    </a>
                }
            </div>
        </div>
    }

}
